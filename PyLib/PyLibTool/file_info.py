# -*- coding: utf-8 -*-
"""
 * @Date: 2021-03-15 11:07:29
 * @LastEditors: Hwrn
 * @LastEditTime: 2022-07-10 12:58:03
 * @FilePath: /metaSC/PyLib/PyLibTool/file_info.py
 * @Description:
    Extract information in __doc__
"""

import logging
from pathlib import Path
from typing import List, Optional, TextIO, Union
from hashlib import md5
from typing import Dict


def extract_doc(module_doc: Optional[str] = None) -> Dict:
    """
    Extract header generated by 'korofildheader'

    >>> import PyLib.PyLibTool.file_info
    >>> from PyLib.PyLibTool.file_info import extract_doc
    >>> extract_doc(PyLib.PyLibTool.file_info.__doc__)["FilePath"]
    ' /metaSC/PyLib/PyLibTool/file_info.py'
    >>> extract_doc(PyLib.PyLibTool.file_info.__doc__)["Description"]
    '\n    Extract information in __doc__'
    """
    doc_list = (module_doc or "").split(" * @")
    doc_dict: Dict = {}
    k = "description"
    for item in doc_list:
        item_ = item.strip().split(":", 1)
        if item_ == [""]:
            continue
        # undefined action
        # elif len(item_) == 1:
        #    print(2)
        #    doc_dict[k] += " * @ " + item_[0]
        elif len(item_) == 2:
            k, v = item_
            doc_dict[k] = v.strip()

    return doc_dict


def verbose_import(module_name, module_doc: Optional[str] = None) -> logging.Logger:
    """ """
    doc_dict = extract_doc(module_doc or "")
    logger = logging.getLogger(module_name)
    LastEditTime = doc_dict.get("LastEditTime", "")
    logger.debug(f"import version {LastEditTime} -- {module_name}")
    return logger


def basicConfig(logger_level: Optional[str] = None, _logger_level=["INFO"]):
    """This function is used in funtion called by joblib.delayed"""
    if logger_level:
        _logger_level[0] = logger_level.upper()
    logger_level = _logger_level[0]
    logging.basicConfig(
        level=logger_level,
        format="%(asctime)s  %(filename)s : %(levelname)s  %(message)s",  # 定义输出log的格式
        datefmt="%Y-%m-%d %H:%M:%S",  # 时间
    )
    return logger_level


def md5sum(text: Optional[bytes] = None, file: Optional[Path] = None, c: Optional[str] = None):
    assert text is not None or file is not None, "text or file must be provided"

    md5s: List[str] = []

    if text:
        textmd5 = md5(text).hexdigest()
        md5s.append(textmd5)
    if file:
        filem = md5()
        with file.open("rb") as fobj:
            while True:
                data = fobj.read(4096)
                if not data:
                    break
                filem.update(data)  # 更新md5对象
        filemd5 = filem.hexdigest()
        md5s.append(filemd5)
    if c:
        md5s.append(c)

    for i in md5s[1:]:
        if i != md5s[0]:
            return False

    return md5s[0]


verbose_import(__name__, __doc__)
